---
import path from "path";

interface Image {
  src: string;
  alt: string;
}

// 1. Image Fetching
let images: Image[] = [];

try {
  const imageFiles = import.meta.glob(
    "/public/images/carousel_gallery/*.{jpg,jpeg,png,gif,webp}",
    {
      eager: true,
      import: "default",
    }
  );

  images = Object.keys(imageFiles).map((filepath) => {
    const src = filepath.replace("/public", "");
    const filename = path.basename(filepath);
    const alt = filename.split(".")[0].replace(/[-_]/g, " ");
    return { src, alt };
  });
} catch (e) {
  console.error("Error loading carousel images:", e);
}

const SLIDE_DURATION = 5000;
---

<div class="relative w-full max-w-6xl mx-auto group perspective-1000 my-8">
  <div
    class="relative overflow-hidden rounded-2xl bg-slate-950 aspect-video shadow-2xl ring-1 ring-white/10 isolate"
  >
    {
      images.length > 0 ? (
        <>
          <div id="carousel-track" class="relative w-full h-full">
            {images.map((image, index) => (
              <div
                class={`absolute inset-0 w-full h-full transition-opacity duration-1000 ease-in-out ${
                  index === 0
                    ? "opacity-100 z-10 active-slide"
                    : "opacity-0 z-0"
                }`}
                data-index={index}
              >
                <img
                  src={image.src}
                  alt={image.alt}
                  class="w-full h-full object-cover cursor-zoom-in ken-burns"
                  loading={index === 0 ? "eager" : "lazy"}
                  fetchpriority={index === 0 ? "high" : "auto"}
                  decoding="async"
                  data-lightbox-src={image.src}
                  data-lightbox-caption={image.alt}
                />

                <div class="absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-black/90 via-black/40 to-transparent pointer-events-none flex items-end">
                  <div class="px-8 py-10 translate-y-4 opacity-0 transition-all duration-700 delay-300 slide-caption">
                    <h3 class="text-white text-2xl font-bold tracking-tight drop-shadow-lg capitalize">
                      {image.alt}
                    </h3>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <div class="absolute bottom-0 left-0 w-full h-1 bg-white/10 z-30">
            <div
              id="progress-bar"
              class="h-full bg-cyan-500 w-full origin-left scale-x-0 group-hover:paused"
              style={`animation-duration: ${SLIDE_DURATION}ms;`}
            />
          </div>

          <button
            id="btn-prev"
            class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 flex items-center justify-center rounded-full bg-black/30 backdrop-blur-md border border-white/10 text-white opacity-0 group-hover:opacity-100 transition-all duration-300 hover:bg-black/60 hover:scale-110 hover:border-cyan-500/50 z-30 focus:opacity-100 focus:outline-none"
            aria-label="Previous slide"
          >
            <span class="material-icons">chevron_left</span>
          </button>

          <button
            id="btn-next"
            class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 flex items-center justify-center rounded-full bg-black/30 backdrop-blur-md border border-white/10 text-white opacity-0 group-hover:opacity-100 transition-all duration-300 hover:bg-black/60 hover:scale-110 hover:border-cyan-500/50 z-30 focus:opacity-100 focus:outline-none"
            aria-label="Next slide"
          >
            <span class="material-icons">chevron_right</span>
          </button>

          <div class="absolute bottom-6 right-6 flex space-x-2 z-30">
            {images.map((_, index) => (
              <button
                class={`dot w-2 h-2 rounded-full transition-all duration-300 ${
                  index === 0
                    ? "bg-cyan-400 w-8"
                    : "bg-white/40 hover:bg-white/80"
                }`}
                aria-label={`Go to slide ${index + 1}`}
                data-index={index}
              />
            ))}
          </div>
        </>
      ) : (
        /* Empty State */
        <div class="w-full h-full flex flex-col items-center justify-center text-slate-500 bg-slate-900">
          <span class="material-icons text-6xl mb-4 opacity-30">
            collections
          </span>
          <p class="text-sm font-mono uppercase tracking-widest">
            Gallery Empty
          </p>
        </div>
      )
    }
  </div>

  <dialog
    id="lightbox"
    class="fixed inset-0 z-[100] w-full h-full bg-black/95 backdrop-blur-sm p-0 m-0 border-none open:animate-fade-in closed:animate-fade-out"
  >
    <div class="w-full h-full flex items-center justify-center relative p-4">
      <button
        id="lightbox-close"
        class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors p-2 z-50"
      >
        <span class="material-icons text-4xl">close</span>
      </button>

      <button
        id="lb-prev"
        class="absolute left-4 top-1/2 -translate-y-1/2 p-4 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-all z-50 hidden md:block"
      >
        <span class="material-icons text-4xl">chevron_left</span>
      </button>

      <img
        id="lightbox-img"
        class="max-w-full max-h-[85vh] object-contain shadow-2xl rounded-sm select-none"
        src=""
        alt=""
        draggable="false"
      />

      <button
        id="lb-next"
        class="absolute right-4 top-1/2 -translate-y-1/2 p-4 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-all z-50 hidden md:block"
      >
        <span class="material-icons text-4xl">chevron_right</span>
      </button>

      <div
        class="absolute bottom-8 left-0 w-full text-center pointer-events-none"
      >
        <p
          id="lightbox-caption"
          class="inline-block px-4 py-2 bg-black/50 backdrop-blur-md rounded-full text-white/90 font-medium tracking-wide"
        >
        </p>
      </div>
    </div>
  </dialog>
</div>

<style>
  /* Ken Burns Effect */
  .active-slide .ken-burns {
    animation: kenBurns 20s ease-out forwards;
  }
  @keyframes kenBurns {
    0% {
      transform: scale(1);
    }
    100% {
      transform: scale(1.15);
    }
  }

  /* Caption Animation */
  .active-slide .slide-caption {
    opacity: 1;
    transform: translateY(0);
  }

  /* Progress Bar Animation */
  .animate-progress {
    animation-name: progressBar;
    animation-timing-function: linear;
    animation-fill-mode: forwards;
  }

  /* Pause animation when hovering the parent group */
  .group:hover .group-hover\:paused {
    animation-play-state: paused;
  }

  @keyframes progressBar {
    0% {
      transform: scaleX(0);
    }
    100% {
      transform: scaleX(1);
    }
  }

  /* Lightbox Animation */
  dialog[open] {
    animation: fadeIn 0.2s ease-out forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>

<script define:vars={{ slideDuration: SLIDE_DURATION }}>
  (() => {
    // Elements
    const track = document.getElementById("carousel-track");
    if (!track) return;

    const slides = Array.from(track.children);
    const dots = Array.from(document.querySelectorAll(".dot"));
    const progressBar = document.getElementById("progress-bar");

    // Lightbox Elements
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    const lightboxCaption = document.getElementById("lightbox-caption");
    const lbPrevBtn = document.getElementById("lb-prev");
    const lbNextBtn = document.getElementById("lb-next");

    let currentIndex = 0;
    let lightboxIndex = 0;
    let autoPlayTimer;

    // --- Core Carousel Logic ---

    function setActiveSlide(index) {
      slides.forEach((slide, i) => {
        const isCurrent = i === index;
        slide.classList.toggle("opacity-100", isCurrent);
        slide.classList.toggle("z-10", isCurrent);
        slide.classList.toggle("active-slide", isCurrent);
        slide.classList.toggle("opacity-0", !isCurrent);
        slide.classList.toggle("z-0", !isCurrent);
      });

      dots.forEach((dot, i) => {
        const isCurrent = i === index;
        dot.classList.toggle("bg-cyan-400", isCurrent);
        dot.classList.toggle("w-8", isCurrent);
        dot.classList.toggle("bg-white/40", !isCurrent);
      });

      // Reset CSS Animation
      if (progressBar) {
        progressBar.classList.remove("animate-progress");
        void progressBar.offsetWidth;
        progressBar.classList.add("animate-progress");
      }
      currentIndex = index;
    }

    function next() {
      const nextIndex = (currentIndex + 1) % slides.length;
      setActiveSlide(nextIndex);
    }

    function prev() {
      const prevIndex = (currentIndex - 1 + slides.length) % slides.length;
      setActiveSlide(prevIndex);
    }

    // --- Autoplay Logic ---

    function startTimer() {
      clearInterval(autoPlayTimer);
      autoPlayTimer = setInterval(() => {
        // Stop autoplay if lightbox is open or user is hovering
        const isHovering = document.querySelector(".group:hover");
        if (!isHovering && !lightbox.open) {
          next();
        }
      }, slideDuration);
    }

    function resetTimer() {
      clearInterval(autoPlayTimer);
      startTimer();
    }

    // Sync with CSS animation
    if (progressBar) {
      progressBar.addEventListener("animationend", () => {
        next();
      });
      progressBar.classList.add("animate-progress");
    } else {
      startTimer();
    }

    // --- Controls ---

    document.getElementById("btn-prev")?.addEventListener("click", () => {
      prev();
      resetTimer();
    });
    document.getElementById("btn-next")?.addEventListener("click", () => {
      next();
      resetTimer();
    });

    dots.forEach((dot, idx) => {
      dot.addEventListener("click", () => {
        setActiveSlide(idx);
        resetTimer();
      });
    });

    // --- Touch Swipe (Carousel) ---
    let touchStartX = 0;
    track.addEventListener(
      "touchstart",
      (e) => (touchStartX = e.changedTouches[0].screenX),
      { passive: true }
    );
    track.addEventListener(
      "touchend",
      (e) => {
        const touchEndX = e.changedTouches[0].screenX;
        if (touchStartX - touchEndX > 50) {
          next();
          resetTimer();
        }
        if (touchEndX - touchStartX > 50) {
          prev();
          resetTimer();
        }
      },
      { passive: true }
    );

    // --- Lightbox Logic ---

    function updateLightboxImage(index) {
      if (index < 0) index = slides.length - 1;
      if (index >= slides.length) index = 0;

      lightboxIndex = index;

      // Get data from the slide's image tag
      const sourceImg = slides[index].querySelector("img");
      if (sourceImg) {
        lightboxImg.src = sourceImg.dataset.lightboxSrc || sourceImg.src;
        lightboxCaption.textContent =
          sourceImg.dataset.lightboxCaption || sourceImg.alt;
      }
    }

    slides.forEach((slide, idx) => {
      const img = slide.querySelector("img");
      if (!img) return;
      img.addEventListener("click", () => {
        updateLightboxImage(idx);
        lightbox.showModal();
        // LOCK SCROLL
        document.body.style.overflow = "hidden";
        clearInterval(autoPlayTimer); // Pause background carousel completely
      });
    });

    const closeLightbox = () => {
      lightbox.close();
      // UNLOCK SCROLL
      document.body.style.overflow = "";
      resetTimer(); // Resume background carousel
    };

    // Lightbox Controls
    document
      .getElementById("lightbox-close")
      ?.addEventListener("click", closeLightbox);

    lbNextBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      updateLightboxImage(lightboxIndex + 1);
    });

    lbPrevBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      updateLightboxImage(lightboxIndex - 1);
    });

    // Close on backdrop click
    lightbox.addEventListener("click", (e) => {
      if (e.target === lightbox) closeLightbox();
    });

    // --- Global Keyboard Nav ---
    document.addEventListener("keydown", (e) => {
      if (lightbox.open) {
        // Control Lightbox
        if (e.key === "ArrowRight") updateLightboxImage(lightboxIndex + 1);
        if (e.key === "ArrowLeft") updateLightboxImage(lightboxIndex - 1);
        if (e.key === "Escape") closeLightbox();
      } else {
        // Control Carousel
        if (e.key === "ArrowRight") {
          next();
          resetTimer();
        }
        if (e.key === "ArrowLeft") {
          prev();
          resetTimer();
        }
      }
    });
  })();
</script>

---
interface Image {
  src: string;
  alt: string;
}

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

let images: Image[] = [];
try {
  // Read files directly from the public images directory at build time
  const publicDir = new URL('../../public/images/carousel_gallery', import.meta.url);
  const dirPath = fileURLToPath(publicDir);
  const files = fs.readdirSync(dirPath);
  const allowed = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
  images = files
    .filter((f) => allowed.includes(path.extname(f).toLowerCase()))
    .map((filename) => ({ src: `/images/carousel_gallery/${filename}`, alt: filename.split('.')[0].replace(/[-_]/g, ' ') }));
} catch (err) {
  // Fallback: try import.meta.glob (works in some environments)
  try {
    const imageFiles = Object.values(
      import.meta.glob('/images/carousel_gallery/*.{jpg,jpeg,png,gif,webp}', {
        query: '?url',
        import: 'default',
        eager: true
      }) as Record<string, string>
    );
    images = imageFiles.map((imageUrl: string) => {
      let filename = String(imageUrl);
      try {
        const url = new URL(imageUrl as string);
        const pathParts = url.pathname.split('/');
        filename = pathParts[pathParts.length - 1];
      } catch {
        const parts = String(imageUrl).split('/');
        filename = parts[parts.length - 1];
      }
      return { src: `/images/carousel_gallery/${filename}`, alt: filename.split('.')[0].replace(/[-_]/g, ' ') };
    });
  } catch (_err) {
    console.warn('No images found in carousel_gallery directory');
    images = [];
  }
}
---

<div class="relative w-full max-w-5xl mx-auto group perspective-1000">
  <div class="relative overflow-hidden rounded-2xl bg-slate-900 aspect-video shadow-2xl ring-1 ring-white/10 transform transition-transform duration-500 hover:scale-[1.01]">
    {images.length > 0 ? (
      <>
        <!-- Images Container -->
        <div class="relative w-full h-full" id="carousel-track">
          {images.map((image, index) => (
            <div 
              class={`absolute inset-0 w-full h-full transition-all duration-1000 ease-in-out ${index === 0 ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}
              data-index={index}
            >
              <img 
                src={image.src} 
                alt={image.alt}
                class={`w-full h-full object-cover cursor-zoom-in carousel-image ${index === 0 ? 'scale-110' : 'scale-100'}`}
                style="transition: transform 6s ease-out;"
                data-src={image.src}
                loading={index === 0 ? 'eager' : 'lazy'}
              />
              <!-- Caption Gradient Overlay -->
              <div class="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-t from-black/80 via-black/40 to-transparent pointer-events-none flex items-end">
                <p class="px-6 py-8 text-white text-lg font-medium tracking-wide drop-shadow-md opacity-0 transform translate-y-4 transition-all duration-700 delay-300 slide-caption">
                  {image.alt}
                </p>
              </div>
            </div>
          ))}
        </div>

        <!-- Progress Bar -->
        <div class="absolute bottom-0 left-0 w-full h-1 bg-white/10 z-20">
            <div id="carousel-progress" class="h-full bg-cyan-500 w-0 transition-all duration-100 ease-linear"></div>
        </div>

        <!-- Controls (Hidden on mobile by default, shown on hover/touch) -->
        <button 
          id="carousel-prev"
          class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 flex items-center justify-center rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-white opacity-0 group-hover:opacity-100 transition-all duration-300 hover:bg-white/20 hover:scale-110 z-20"
          aria-label="Previous image"
        >
          <span class="material-icons">chevron_left</span>
        </button>
        <button 
          id="carousel-next"
          class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 flex items-center justify-center rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-white opacity-0 group-hover:opacity-100 transition-all duration-300 hover:bg-white/20 hover:scale-110 z-20"
          aria-label="Next image"
        >
          <span class="material-icons">chevron_right</span>
        </button>

        <!-- Indicators -->
        <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex space-x-3 z-30">
          {images.map((_, index) => (
            <button 
              class={`carousel-dot w-2 h-2 rounded-full transition-all duration-300 ${index === 0 ? 'bg-cyan-400 w-6' : 'bg-white/40 hover:bg-white/80'}`}
              aria-label={`Go to slide ${index + 1}`}
              data-index={index}
            ></button>
          ))}
        </div>
      </>
    ) : (
      <div class="w-full h-full flex items-center justify-center text-slate-500">
        <div class="text-center">
            <span class="material-icons text-5xl mb-2 opacity-50">image_not_supported</span>
            <p>No images found in gallery.</p>
        </div>
      </div>
    )}
  </div>

  <!-- Lightbox Modal -->
  <div id="imageModal" class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center p-4">
    <button 
      id="modal-close"
      class="absolute top-6 right-6 text-white/70 hover:text-white transition-colors"
      aria-label="Close modal"
    >
      <span class="material-icons text-4xl">close</span>
    </button>
    <img id="modalImage" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" src="" alt="Enlarged view">
    <p id="modalCaption" class="absolute bottom-6 left-0 w-full text-center text-slate-300 font-medium tracking-wide"></p>
  </div>
</div>

<script is:inline>
  // encapsulating in IIFE to avoid global scope pollution if multiple carousels
  (() => {
    let currentIndex = 0;
    let slideTimer;
    let progressTimer;
    let slides = [];
    let dots = [];
    let totalSlides = 0;
    let progress = 0;
    const DURATION = 5000; // 5 seconds per slide
    const UPDATE_FREQ = 50; // Update progress bar every 50ms
    let isPaused = false;
    let touchStartX = 0;
    let touchEndX = 0;

    function init() {
        slides = Array.from(document.querySelectorAll('[data-index]')).filter(el => el.parentElement.id === 'carousel-track');
        dots = Array.from(document.querySelectorAll('.carousel-dot'));
        totalSlides = slides.length;
        
        if (totalSlides === 0) return;

        startAutoPlay();
        
        // Event Listeners
        document.getElementById('carousel-prev')?.addEventListener('click', () => { manualNavigate(-1); });
        document.getElementById('carousel-next')?.addEventListener('click', () => { manualNavigate(1); });
        
        dots.forEach(dot => {
            dot.addEventListener('click', () => {
                const idx = Number(dot.getAttribute('data-index'));
                goToSlide(idx);
            });
        });

        // Pause on hover
        const container = document.querySelector('.group');
        container?.addEventListener('mouseenter', () => isPaused = true);
        container?.addEventListener('mouseleave', () => isPaused = false);

        // Touch Swipe
        const track = document.getElementById('carousel-track');
        track?.addEventListener('touchstart', (e) => touchStartX = e.changedTouches[0].screenX);
        track?.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        // Setup Image Modal
        setupModal();
    }

    function handleSwipe() {
        const threshold = 50;
        if (touchStartX - touchEndX > threshold) manualNavigate(1); // Swipe Left -> Next
        if (touchEndX - touchStartX > threshold) manualNavigate(-1); // Swipe Right -> Prev
    }

    function manualNavigate(dir) {
        navigate(dir);
        resetTimer();
    }

    function resetTimer() {
        progress = 0;
        updateProgressBar();
    }

    function startAutoPlay() {
        // Clear existing interval just in case
        if (progressTimer) clearInterval(progressTimer);
        
        progressTimer = setInterval(() => {
            if (!isPaused) {
                progress += (UPDATE_FREQ / DURATION) * 100;
                if (progress >= 100) {
                    navigate(1);
                    progress = 0;
                }
                updateProgressBar();
            }
        }, UPDATE_FREQ);
    }

    function updateProgressBar() {
        const bar = document.getElementById('carousel-progress');
        if (bar) bar.style.width = `${progress}%`;
    }

    function navigate(direction) {
        let nextIndex = (currentIndex + direction + totalSlides) % totalSlides;
        updateSlide(nextIndex);
        currentIndex = nextIndex;
    }

    function goToSlide(index) {
        if (index === currentIndex) return;
        updateSlide(index);
        currentIndex = index;
        resetTimer();
    }

    function updateSlide(nextIndex) {
        // Current Slide: Fade Out & Reset Scale
        const currentSlide = slides[currentIndex];
        const currentImg = currentSlide.querySelector('img');
        const currentCaption = currentSlide.querySelector('.slide-caption');
        
        currentSlide.classList.remove('opacity-100', 'z-10');
        currentSlide.classList.add('opacity-0', 'z-0');
        if (currentImg) currentImg.classList.remove('scale-110'); // Reset scale
        if (currentCaption) {
             currentCaption.classList.remove('opacity-100', 'translate-y-0');
             currentCaption.classList.add('opacity-0', 'translate-y-4');
        }

        // Next Slide: Fade In & Start Scale
        const nextSlide = slides[nextIndex];
        const nextImg = nextSlide.querySelector('img');
        const nextCaption = nextSlide.querySelector('.slide-caption');

        nextSlide.classList.remove('opacity-0', 'z-0');
        nextSlide.classList.add('opacity-100', 'z-10');
        
        // Small delay to ensure transition triggers
        setTimeout(() => {
            if (nextImg) nextImg.classList.add('scale-110'); // Start Ken Burns
             if (nextCaption) {
                nextCaption.classList.remove('opacity-0', 'translate-y-4');
                nextCaption.classList.add('opacity-100', 'translate-y-0');
            }
        }, 50);

        // Update Dots
        dots.forEach((dot, idx) => {
            if (idx === nextIndex) {
                dot.classList.remove('bg-white/40', 'hover:bg-white/80');
                dot.classList.add('bg-cyan-400', 'w-6');
            } else {
                 dot.classList.add('bg-white/40', 'hover:bg-white/80');
                 dot.classList.remove('bg-cyan-400', 'w-6');
            }
        });
    }

    function setupModal() {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const modalCaption = document.getElementById('modalCaption');
        const closeBtn = document.getElementById('modal-close');

        if (!modal) return;

        document.querySelectorAll('.carousel-image').forEach(img => {
            img.addEventListener('click', () => {
                if (modalImg && img.dataset.src) {
                    modalImg.src = img.dataset.src;
                    modalCaption.innerText = img.alt;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    isPaused = true; // Pause carousel while modal is open
                }
            });
        });

        const closeModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            isPaused = false; // Resume carousel
        };

        closeBtn?.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
  })();
</script>

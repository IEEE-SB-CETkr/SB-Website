<!--
 * Website for IEEE SB CETKR
 * Copyright (C) 2025 IEEE Student Branch CETKR
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
-->
---
import { Image } from 'astro:assets';
import '../styles/components/gallery.css';

interface GalleryItem {
  type: 'image' | 'video';
  url: string;
  alt?: string;
  caption?: string;
}

interface Props {
  items: GalleryItem[];
  className?: string;
}

const { items = [], className = '' } = Astro.props;
const galleryId = `gallery-${Math.random().toString(36).substring(2, 9)}`;
---

<div id={galleryId} class:list={['gallery-grid', className]}>
  {items.map((item, index) => (
    <a
      href={item.url}
      data-type={item.type}
      data-caption={item.caption}
      data-index={index}
      class="gallery-item group"
      aria-label={`View item ${index + 1}: ${item.caption || item.alt || ''}`}
    >
      {item.type === 'image' ? (
        <Image
          src={item.url}
          alt={item.alt || 'Gallery image'}
          width={400}
          height={300}
          format="webp"
          quality={80}
          loading="lazy"
          class="gallery-thumbnail"
        />
      ) : (
        <div class="video-thumbnail-wrapper">
          <video
            src={item.url}
            class="gallery-thumbnail"
            preload="metadata"
            muted
            loop
            playsinline
          >
            Your browser does not support the video tag.
          </video>
          <div class="video-play-icon">
            <svg viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 0 0 4 4.118v11.764a1.5 1.5 0 0 0 2.3 1.277l9.344-5.882a1.5 1.5 0 0 0 0-2.554L6.3 2.84Z"></path></svg>
          </div>
        </div>
      )}
      {item.caption && <div class="caption">{item.caption}</div>}
    </a>
  ))}
</div>

<div id="lightbox" class="lightbox-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="lightbox-caption">
  <div class="lightbox-content">
    <div class="lightbox-media-wrapper">
  <img id="lightbox-image" class="lightbox-media hidden" alt="Lightbox view" />
  <video id="lightbox-video" class="lightbox-media hidden" controls playsinline></video>
    </div>
    <div id="lightbox-caption" class="lightbox-caption"></div>
  </div>
  <button id="lightbox-close" class="lightbox-button close" aria-label="Close lightbox">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18 18 6M6 6l12 12"></path></svg>
  </button>
  <button id="lightbox-prev" class="lightbox-button prev" aria-label="Previous item">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m15 19-7-7 7-7"></path></svg>
  </button>
  <button id="lightbox-next" class="lightbox-button next" aria-label="Next item">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m9 5 7 7-7 7"></path></svg>
  </button>
  <div id="lightbox-counter" class="lightbox-counter"></div>
</div>

<script define:vars={{ galleryId, items }}>
  document.addEventListener('DOMContentLoaded', () => {
    const gallery = document.getElementById(galleryId);
    if (!gallery) return;

    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxVideo = document.getElementById('lightbox-video');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const lightboxCounter = document.getElementById('lightbox-counter');
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');

    let currentIndex = 0;
    let touchStartX = 0;
    let touchEndX = 0;

    const galleryItems = Array.from(gallery.querySelectorAll('.gallery-item'));

    function showItem(index) {
      currentIndex = index;
      const item = galleryItems[index];
      const type = item.dataset.type;
      const url = item.href;
      const caption = item.dataset.caption;

      if (type === 'image') {
        lightboxImage.src = url;
        lightboxImage.style.display = 'block';
        lightboxVideo.style.display = 'none';
        lightboxVideo.pause();
        lightboxVideo.src = '';
      } else {
        lightboxVideo.src = url;
        lightboxVideo.style.display = 'block';
        lightboxVideo.autoplay = true;
        lightboxImage.style.display = 'none';
        lightboxImage.src = '';
      }

      lightboxCaption.textContent = caption || '';
      lightboxCounter.textContent = `${index + 1} / ${galleryItems.length}`;

      lightbox.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      prevBtn.style.display = galleryItems.length > 1 ? 'flex' : 'none';
      nextBtn.style.display = galleryItems.length > 1 ? 'flex' : 'none';

      preload(currentIndex + 1);
      preload(currentIndex - 1);
    }

    function hideLightbox() {
      lightbox.style.display = 'none';
      lightboxVideo.pause();
      document.body.style.overflow = '';
    }

    function showNext() {
      showItem((currentIndex + 1) % galleryItems.length);
    }

    function showPrev() {
      showItem((currentIndex - 1 + galleryItems.length) % galleryItems.length);
    }
    
    function preload(index) {
      const total = galleryItems.length;
      if (index < 0 || index >= total) return;
      const item = galleryItems[index];
      if (item.dataset.type === 'image') {
        const img = new Image();
        img.src = item.href;
      }
    }

    gallery.addEventListener('click', (e) => {
      e.preventDefault();
      const targetItem = e.target.closest('.gallery-item');
      if (targetItem) {
        showItem(parseInt(targetItem.dataset.index));
      }
    });

    closeBtn.addEventListener('click', hideLightbox);
    nextBtn.addEventListener('click', showNext);
    prevBtn.addEventListener('click', showPrev);

    document.addEventListener('keydown', (e) => {
      if (lightbox.style.display === 'flex') {
        if (e.key === 'Escape') hideLightbox();
        if (e.key === 'ArrowRight') showNext();
        if (e.key === 'ArrowLeft') showPrev();
      }
    });

    lightbox.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX }, { passive: true });
    lightbox.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      if (touchEndX < touchStartX - 50) showNext();
      if (touchEndX > touchStartX + 50) showPrev();
    });
  });
</script>
---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

export async function getStaticPaths() {
  const newsletters = await getCollection("newsletters");
  return newsletters.map((newsletter) => ({
    params: { slug: newsletter.slug },
    props: {
      newsletter,
      title: newsletter.data.title,
      description:
        newsletter.data.description ||
        `Read the latest newsletter: ${newsletter.data.title}`,
    },
  }));
}

const { newsletter, title, description } = Astro.props;
const { Content } = await newsletter.render();
const { pubDate, image } = newsletter.data;
---

<!--
 * Website for IEEE SB CETKR
 * Copyright (C) 2025 IEEE Student Branch CETKR
-->
<Header />

<Layout title={title} description={description} image={image?.url}>
  <!-- Background Elements (Copied from Chapters/Events) -->
  <div class="fixed inset-0 z-0 overflow-hidden pointer-events-none">
    <div
      class="absolute top-0 right-[10%] w-[600px] h-[600px] bg-blue-100/40 rounded-full blur-[120px] mix-blend-multiply"
    >
    </div>
    <div
      class="absolute bottom-0 left-[10%] w-[600px] h-[600px] bg-purple-100/40 rounded-full blur-[120px] mix-blend-multiply"
    >
    </div>
  </div>

  <main class="relative pt-40 pb-16 bg-transparent">
    <div class="container mx-auto px-4 sm:px-6 max-w-4xl">
      <nav class="mb-8" data-aos="fade-up" data-aos-duration="600">
        <a
          href="/newsletters"
          class="group inline-flex items-center text-zinc-500 hover:text-blue-600 transition-colors text-sm font-medium bg-zinc-50 hover:bg-white px-4 py-2 rounded-full border border-zinc-200 shadow-sm"
        >
          <span
            class="material-icons text-sm mr-2 group-hover:-translate-x-1 transition-transform"
          >
            arrow_back
          </span>
          Back to Newsletters
        </a>
      </nav>

      <article
        class="prose prose-zinc lg:prose-lg mx-auto bg-white/70 backdrop-blur-xl p-8 md:p-12 rounded-3xl border border-zinc-200 shadow-[0_8px_30px_rgb(0,0,0,0.04)] relative overflow-hidden"
        data-aos="fade-up"
        data-aos-duration="800"
        data-aos-delay="100"
      >
        <div
          class="absolute inset-0 bg-gradient-to-b from-white/50 via-transparent to-transparent pointer-events-none"
        >
        </div>

        <header class="mb-10 text-center relative z-10">
          <time
            class="inline-block px-4 py-1.5 mb-6 text-sm font-bold text-blue-700 bg-blue-50 border border-blue-100 rounded-full"
          >
            {
              pubDate.toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </time>
          <h1
            class="text-3xl md:text-4xl lg:text-5xl font-bold text-zinc-900 mb-6 leading-tight !mt-0"
          >
            {title}
          </h1>
          {
            image && (
              <div class="rounded-2xl overflow-hidden shadow-lg border border-zinc-200 mt-8 aspect-video relative max-w-4xl mx-auto">
                <img
                  src={image.url}
                  alt={image.alt || title}
                  class="w-full h-full object-cover !my-0"
                />
              </div>
            )
          }
          {
            description && (
              <div class="mt-8 text-left">
                <p class="text-xl text-zinc-600 leading-relaxed font-serif italic border-l-4 border-blue-500/30 pl-6 py-2 bg-blue-50/30 rounded-r-lg">
                  {description}
                </p>
              </div>
            )
          }
        </header>

        <div class="relative z-10">
          <Content />
        </div>
      </article>

      <script>
        // Apply inline styles for images with width/height attributes
        document.addEventListener("DOMContentLoaded", () => {
          document
            .querySelectorAll<HTMLElement>("img[width][height]")
            .forEach((img) => {
              img.style.setProperty(
                "--img-width",
                img.getAttribute("width") + "px"
              );
              img.style.setProperty(
                "--img-height",
                img.getAttribute("height") + "px"
              );
            });
        });
      </script>
    </div>
  </main>
</Layout>
<Footer />

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    // Add copy buttons to all pre elements
    document.querySelectorAll("pre").forEach((pre) => {
      // Skip if already has a copy button
      if (pre.querySelector(".copy-button")) return;

      // Create copy button
      const button = document.createElement("button");
      button.className = "copy-button";
      button.title = "Copy to clipboard";
      button.innerHTML = `
        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
        <span>Copy</span>
      `;

      // Add button to pre element
      pre.style.position = "relative";
      pre.prepend(button);

      // Add click event to copy code
      button.addEventListener("click", async () => {
        const code = pre.querySelector("code");
        if (!code) return;

        try {
          await navigator.clipboard.writeText(code.textContent || "");

          // Update button state
          const originalText = button.innerHTML;
          button.innerHTML = `
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span>Copied!</span>
          `;
          button.classList.add("copied");

          // Reset button after 2 seconds
          setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove("copied");
          }, 2000);
        } catch (err) {
          console.error("Failed to copy text: ", err);
          button.textContent = "Error";
          button.style.color = "#ef4444";
          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.color = "";
          }, 2000);
        }
      });
    });
  });
</script>

<style is:global>
  .copy-button {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    color: #71717a; /* zinc-500 */
    background-color: rgba(255, 255, 255, 0.8);
    border: 1px solid #e4e4e7; /* zinc-200 */
    border-radius: 0.375rem;
    cursor: pointer;
    backdrop-filter: blur(4px);
    transition: all 0.2s;
    opacity: 0;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  pre:hover .copy-button {
    opacity: 1;
  }

  .copy-button:hover {
    background-color: #eff6ff; /* blue-50 */
    color: #2563eb; /* blue-600 */
    border-color: #bfdbfe; /* blue-200 */
  }

  .copy-button.copied {
    background-color: #f0fdf4; /* green-50 */
    color: #16a34a; /* green-600 */
    border-color: #bbf7d0; /* green-200 */
  }
</style>
